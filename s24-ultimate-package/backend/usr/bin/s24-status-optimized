#!/bin/sh
# S24 Status - Optimized with caching

CACHE="/tmp/s24-status-cache"
CACHE_TTL=30

# Check cache
if [ -f "$CACHE" ]; then
    AGE=$(($(date +%s) - $(stat -f %m "$CACHE" 2>/dev/null || echo 0)))
    [ $AGE -lt $CACHE_TTL ] && cat "$CACHE" && exit 0
fi

# VPN status (single check)
VPN_CONNECTED="false"
VPN_SERVER="null"
if [ -f /tmp/s24-vpn-state ]; then
    STATUS=$(head -n1 /tmp/s24-vpn-state)
    [ "$STATUS" = "connected" ] && {
        VPN_CONNECTED="true"
        SERVER=$(tail -n1 /tmp/s24-vpn-state)
        VPN_SERVER="\"$SERVER\""
    }
fi

# Device count (cached from stats)
DEVICES=$(wc -l < /tmp/dhcp.leases 2>/dev/null || echo 0)

# Kill switch status
KILLSWITCH="false"
[ -f /tmp/s24-killswitch ] && [ "$(cat /tmp/s24-killswitch)" = "enabled" ] && KILLSWITCH="true"

# Generate and cache
RESPONSE='{"vpnConnected":'$VPN_CONNECTED',"selectedServer":'$VPN_SERVER',"devices":'$DEVICES',"killSwitch":'$KILLSWITCH'}'
echo "$RESPONSE" | tee "$CACHE"
